{{ define "main" }}
<section class="max-w-4xl mx-auto px-4 py-8 md:py-12">
  <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-8 text-center">
    Search
  </h1>

  <div class="mb-8">
    <input
      id="search-input"
      class="w-full px-4 py-3 bg-white dark:bg-black border border-gray-200 dark:border-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 dark:text-white"
      type="text"
      autocomplete="off"
      placeholder="記事や作品のID、キーワードを入力してください。"
    />
  </div>

  <p id="search-message" class="text-center text-gray-600 dark:text-white mb-6"></p>
  <div id="search-results" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
</section>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const input = document.getElementById("search-input");
  const message = document.getElementById("search-message");
  const resultsContainer = document.getElementById("search-results");

  let fuse;
  let searchData = [];

  message.textContent = "検索データを読み込み中...";

  try {
    const response = await fetch("/index.json");
    searchData = await response.json();

    const options = {
      keys: [
        { name: "title", weight: 0.8 },
        { name: "content", weight: 0.5 },
        { name: "summary", weight: 0.3 }
      ],
      threshold: 0.3,
      ignoreLocation: true,
      includeMatches: true,
      minMatchCharLength: 2
    };
    fuse = new Fuse(searchData, options);
    message.textContent = "";
  } catch (error) {
    console.error("検索データの読み込みに失敗しました:", error);
    message.textContent = "検索データの読み込みに失敗しました。";
    return;
  }

  input.addEventListener("input", () => {
    if (input.value.trim().length > 0) {
      performSearch();
    } else {
      resultsContainer.innerHTML = "";
      message.textContent = "";
    }
  });

  function performSearch() {
    const query = input.value.trim();
    resultsContainer.innerHTML = "";

    if (!query) {
      message.textContent = "キーワードを入力してください。";
      return;
    }

    if (!fuse) {
      message.textContent = "検索エンジンが準備できていません。";
      return;
    }

    const results = fuse.search(query);

    if (results.length === 0) {
      message.textContent = `"${query}" に該当する記事・作品は見つかりませんでした。`;
      return;
    }

    message.textContent = `${results.length}件の結果が見つかりました。`;

    results.forEach((result, index) => {
      const item = result.item;
      const card = document.createElement("a");
      card.href = item.uri;
      card.classList.add("bg-white", "dark:bg-black", "border", "border-gray-200", "dark:border-white", "rounded-xl", "p-6", "hover:shadow-xl", "transition-all", "duration-300", "hover:-translate-y-1");
      
      card.style.animationDelay = `${index * 0.05}s`;

      card.innerHTML = `
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2">${item.title}</h2>
        <p class="text-gray-600 dark:text-white text-sm">${item.summary || ''}</p>
      `;
      resultsContainer.appendChild(card);
    });
  }
});
</script>
{{ end }}
